<!--
============================================================================
USER UI - Chat Interface + Admin Debug Panel
============================================================================

Bu dosya kullanıcı arayüzünü içerir. İki panel var:
1. User Panel: Chat arayüzü (WhatsApp benzeri)
2. Admin Panel: Flow debug (SSE events, LLM reasoning vb.)

FLOW'daki Rolü:
- ① Kullanıcı mesajını Agent'a gönderir
- ⑥ Agent'tan offer alır, gösterir
- ⑦ Kullanıcı onayını Agent'a gönderir
- ⑪⑬ MCP Server'dan SSE event'lerini dinler, gösterir
- ⑭ Task done gösterir

Teknolojiler:
- Vanilla JavaScript (framework yok)
- CSS Variables (WhatsApp renk paleti)
- EventSource API (SSE için)

Port: 3000 (server.js ile serve ediliyor)
============================================================================
-->
<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP + CAMARA POC</title>
  <style>
    /* Reset - Tüm elementlerin default margin/padding'ini sıfırla */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* =========================================================================
       WHATSAPP COLOR PALETTE
       WhatsApp'ın karanlık temasından alınan renkler
       ========================================================================= */
    :root {
      --wa-dark-green: #075e54;
      /* Header arka planı */
      --wa-teal: #128c7e;
      /* Butonlar, vurgular */
      --wa-light-green: #25d366;
      /* Başarı, onay rengi */
      --wa-chat-bg: #0b141a;
      /* Ana arka plan (en koyu) */
      --wa-panel-bg: #111b21;
      /* Panel arka planı */
      --wa-input-bg: #202c33;
      /* Input alanları */
      --wa-outgoing: #005c4b;
      /* Giden mesaj (kullanıcı) */
      --wa-incoming: #202c33;
      /* Gelen mesaj (bot) */
      --wa-text: #e9edef;
      /* Ana metin rengi */
      --wa-text-secondary: #8696a0;
      /* İkincil metin (zaman vb.) */
      --wa-border: #2a3942;
      /* Kenarlıklar */
    }

    /* Ana body stili */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--wa-chat-bg);
      color: var(--wa-text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* =========================================================================
       HEADER
       Üst bar - başlık ve panel geçiş butonu
       ========================================================================= */
    .header {
      background: var(--wa-panel-bg);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--wa-border);
    }

    .header h1 {
      font-size: 18px;
      color: var(--wa-light-green);
    }

    /* Panel geçiş butonu */
    .toggle-btn {
      background: var(--wa-teal);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
    }

    .toggle-btn:hover {
      background: var(--wa-light-green);
    }

    /* Bandwidth Göstergesi */
    .bandwidth-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--wa-input-bg);
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--wa-border);
    }

    .bandwidth-label {
      color: var(--wa-text-secondary);
      font-size: 12px;
    }

    .bandwidth-value {
      color: var(--wa-light-green);
      font-weight: bold;
      font-size: 14px;
      min-width: 80px;
      text-align: center;
    }

    .bandwidth-value.updating {
      animation: pulse 0.5s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    /* =========================================================================
       CONTAINER & PANELS
       Ana içerik alanı ve panel yapısı
       ========================================================================= */
    .container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow: hidden;
    }

    .panel.hidden {
      display: none;
    }

    /* Gizli panel */

    /* =========================================================================
       CHAT MESSAGES - USER PANEL
       Mesaj baloncukları
       ========================================================================= */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
    }

    .message {
      padding: 8px 12px;
      margin: 6px 0;
      border-radius: 8px;
      max-width: 85%;
      font-size: 14px;
      line-height: 1.4;
    }

    /* Kullanıcı mesajı - sağda, yeşil arka plan */
    .message.user {
      background: var(--wa-outgoing);
      margin-left: auto;
      /* Sağa yasla */
      border-bottom-right-radius: 0;
      /* WhatsApp baloncuk stili */
    }

    /* Bot mesajı - solda, koyu arka plan */
    .message.bot {
      background: var(--wa-incoming);
      border-bottom-left-radius: 0;
    }

    /* Offer mesajı - sol kenarı yeşil çizgi */
    .message.offer {
      background: var(--wa-incoming);
      border-left: 3px solid var(--wa-light-green);
    }

    /* Başarı mesajı */
    .message.success {
      background: var(--wa-incoming);
      border-left: 3px solid var(--wa-light-green);
    }

    /* Çalışıyor/bekliyor mesajı */
    .message.working {
      background: var(--wa-incoming);
      border-left: 3px solid var(--wa-teal);
    }

    /* =========================================================================
       INPUT AREA
       Mesaj yazma alanı
       ========================================================================= */
    .input-area {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: var(--wa-panel-bg);
      border-radius: 8px;
    }

    .input-area input {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 20px;
      background: var(--wa-input-bg);
      color: var(--wa-text);
      font-size: 14px;
    }

    .input-area input::placeholder {
      color: var(--wa-text-secondary);
    }

    /* Gönder butonu - yuvarlak */
    .input-area button {
      padding: 12px 20px;
      background: var(--wa-teal);
      border: none;
      border-radius: 50%;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      width: 48px;
      height: 48px;
    }

    .input-area button:hover {
      background: var(--wa-light-green);
    }

    /* =========================================================================
       ADMIN PANEL - FLOW DEBUG
       Debug bilgilerini gösteren panel
       ========================================================================= */
    .admin-panel {
      background: var(--wa-panel-bg);
    }

    .admin-panel h2 {
      margin-bottom: 15px;
      color: var(--wa-light-green);
      font-size: 16px;
    }

    .flow-list {
      flex: 1;
      overflow-y: auto;
    }

    /* Her bir flow adımı */
    .flow-step {
      padding: 12px;
      margin: 8px 0;
      background: var(--wa-input-bg);
      border-radius: 8px;
      border-left: 3px solid var(--wa-border);
      font-size: 13px;
    }

    /* Flow step renkleri - türe göre */
    .flow-step.highlight {
      border-left-color: var(--wa-light-green);
    }

    /* User input, offer */
    .flow-step.llm {
      border-left-color: #f59e0b;
      background: #1a1a0a;
    }

    /* LLM related - turuncu */
    .flow-step.tool {
      border-left-color: #3b82f6;
      background: #0a1a2a;
    }

    /* Tool related - mavi */
    .flow-step.sse {
      border-left-color: #8b5cf6;
      background: #1a0a2a;
    }

    /* SSE related - mor */

    /* Flow step durumları */
    .flow-step.pending {
      border-left-color: var(--wa-border);
      opacity: 0.7;
    }

    .flow-step.active {
      border-left-color: var(--wa-teal);
    }

    .flow-step.done {
      border-left-color: var(--wa-light-green);
    }

    .flow-step.error {
      border-left-color: #ef4444;
      background: #2a0a0a;
    }

    .flow-step.substep {
      margin-left: 14px;
      padding-left: 14px;
      border-left-width: 2px;
    }

    /* Flow step header */
    .flow-step .step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .flow-step .step-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .flow-step .step-label {
      color: var(--wa-light-green);
      font-weight: bold;
      font-size: 11px;
      text-transform: uppercase;
    }

    .flow-step .step-route {
      color: var(--wa-light-green);
      font-size: 10px;
      letter-spacing: 0.3px;
      opacity: 0.9;
      text-transform: uppercase;
    }

    .flow-step .step-time {
      color: var(--wa-text-secondary);
      font-size: 11px;
    }

    .flow-step .step-content {
      color: var(--wa-text);
      margin-bottom: 8px;
    }

    .flow-step .step-direction {
      color: var(--wa-text-secondary);
      font-size: 11px;
      text-transform: uppercase;
    }

    .flow-step .step-desc {
      color: var(--wa-text-secondary);
      font-size: 11px;
      margin-bottom: 8px;
    }

    .flow-step .step-log {
      margin-bottom: 8px;
    }

    .flow-step .step-muted {
      color: var(--wa-text-secondary);
      font-size: 11px;
      font-style: italic;
    }

    /* JSON data gösterimi */
    .flow-step .step-data {
      padding: 8px;
      background: var(--wa-chat-bg);
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
      color: var(--wa-text-secondary);
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <!-- =========================================================================
       HEADER
       ========================================================================= -->
  <div class="header">
    <h1>Network Assistant</h1>

    <!-- Bandwidth Göstergesi -->
    <div class="bandwidth-indicator">
      <span class="bandwidth-label">Mevcut Bandwidth:</span>
      <span class="bandwidth-value" id="bandwidthValue">200 Mbps</span>
    </div>

    <!-- Panel geçiş butonu - tıklandığında togglePanel() çağrılır -->
    <button class="toggle-btn" onclick="togglePanel()">Admin Panel</button>
  </div>

  <div class="container">
    <!-- =========================================================================
         USER PANEL - Chat Arayüzü
         ========================================================================= -->
    <div class="panel" id="userPanel">
      <!-- Mesajların gösterildiği alan -->
      <div class="chat-messages" id="chatMessages"></div>

      <!-- Mesaj yazma alanı -->
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="İstediğiniz talebi yazın..."
          onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">➤</button>
      </div>
    </div>

    <!-- =========================================================================
         ADMIN PANEL - Flow Debug
         ========================================================================= -->
    <div class="panel hidden admin-panel" id="adminPanel">
      <h2>Flow Debug Panel</h2>
      <!-- Flow adımlarının gösterildiği alan -->
      <div class="flow-list" id="flowList"></div>
    </div>
  </div>

  <script>
    // ===========================================================================
    // CONFIGURATION
    // ===========================================================================

    // Agent API adresi - tüm istekler buraya gider (SSE dahil)
    // flow.md'ye göre: UI ↔ Agent ↔ MCP Server
    const AGENT_URL = 'http://localhost:5003';

    // CAMARA API - sadece başlangıç bandwidth'i almak için
    const CAMARA_URL = 'http://localhost:5002';

    // Her sayfa yüklemesinde unique session ID oluştur
    // Bu, pending action'ları takip etmek için kullanılıyor
    let sessionId = 'session_' + Date.now();

    // Aktif panel (user veya admin)
    let currentPanel = 'user';

    // Flow state (flow.md ile birebir - 11a ve 13a dahil)
    const FLOW_STEPS = [
      { id: 1, label: '① USER INPUT', direction: 'UI → Agent', desc: 'Kullanıcı mesajı gönderildi.' },
      { id: 2, label: '② MCP TOOLS REQUEST', direction: 'Agent → MCP', desc: 'tools/list isteği yapıldı.' },
      { id: 3, label: '③ MCP TOOLS RESPONSE', direction: 'MCP → Agent', desc: 'tools/list cevabı alındı.' },
      { id: 4, label: '④ LLM INPUT', direction: 'Agent → LLM', desc: 'LLM\'e prompt gönderildi.' },
      { id: 5, label: '⑤ LLM ACTION PLAN', direction: 'LLM → Agent', desc: 'Tool seçimi ve parametreler alındı.' },
      { id: 6, label: '⑥ OFFER', direction: 'Agent → UI', desc: 'Kullanıcıya teklif sunuldu.' },
      { id: 7, label: '⑦ USER CONFIRM', direction: 'UI → Agent', desc: 'Kullanıcı onayı alındı.' },
      { id: 8, label: '⑧ EXECUTE', direction: 'Agent → MCP', desc: 'tools/call isteği gönderildi (HTTP).' },
      { id: 9, label: '⑨ CAMARA API CALL', direction: 'MCP → CAMARA', desc: 'POST /sessions çağrısı (HTTP).' },
      { id: 10, label: '⑩ CAMARA 201 CREATED', direction: 'CAMARA → MCP', desc: '201 Created cevabı (HTTP).' },
      { id: 11, label: '⑪ SSE WORKING', direction: 'MCP → Agent', desc: 'WORKING SSE (MCP\'den Agent\'a).' },
      { id: '11a', label: '⑪a SSE PROXY', direction: 'Agent → UI', desc: 'SSE proxy (Agent\'dan UI\'a).', isSubstep: true },
      { id: 12, label: '⑫ CAMARA NOTIFY', direction: 'CAMARA → MCP', desc: '/notify callback (HTTP).' },
      { id: 13, label: '⑬ SSE SUCCESS', direction: 'MCP → Agent', desc: 'SUCCESS SSE (MCP\'den Agent\'a).' },
      { id: '13a', label: '⑬a SSE PROXY', direction: 'Agent → UI', desc: 'SSE proxy (Agent\'dan UI\'a).', isSubstep: true },
      { id: 14, label: '⑭ TASK DONE', direction: 'UI', desc: 'İşlem tamamlandı.' }
    ];

    const flowState = new Map();
    let flowInProgress = false;

    function resetFlow() {
      flowState.clear();
      FLOW_STEPS.forEach(step => {
        flowState.set(step.id, { status: 'pending', logs: [] });
      });
      renderFlowSteps();
    }

    resetFlow();

    // ===========================================================================
    // INITIAL BANDWIDTH FETCH
    // Sayfa yüklendiğinde CAMARA'dan mevcut bandwidth'i al
    // ===========================================================================
    async function fetchInitialBandwidth() {
      try {
        const response = await fetch(`${CAMARA_URL}/network-context`);
        const data = await response.json();
        const bandwidthEl = document.getElementById('bandwidthValue');
        bandwidthEl.textContent = data.currentBandwidth;
        console.log('[UI] Initial bandwidth fetched:', data.currentBandwidth);
      } catch (err) {
        console.error('[UI] Failed to fetch initial bandwidth:', err);
      }
    }

    // Sayfa yüklendiğinde bandwidth'i al
    window.addEventListener('DOMContentLoaded', fetchInitialBandwidth);

    // ===========================================================================
    // PANEL TOGGLE
    // User ve Admin panel arasında geçiş
    // ===========================================================================
    function togglePanel() {
      const userPanel = document.getElementById('userPanel');
      const adminPanel = document.getElementById('adminPanel');
      const btn = document.querySelector('.toggle-btn');

      if (currentPanel === 'user') {
        // User -> Admin geçişi
        userPanel.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        btn.textContent = 'User Panel';
        currentPanel = 'admin';
      } else {
        // Admin -> User geçişi
        adminPanel.classList.add('hidden');
        userPanel.classList.remove('hidden');
        btn.textContent = 'Admin Panel';
        currentPanel = 'user';
      }
    }

    // ===========================================================================
    // CHAT MESSAGES
    // User panel'e mesaj ekleme
    // ===========================================================================
    function addMessage(text, type = 'bot') {
      const messages = document.getElementById('chatMessages');

      // Yeni mesaj elementi oluştur
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.innerHTML = text; // innerHTML kullanıyoruz çünkü <strong> vs. olabilir

      // Mesajı ekle ve scroll'u aşağı kaydır
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    // ===========================================================================
    // FLOW STEPS (flow.md ile birebir 14 adım)
    // ===========================================================================
    function addFlowLog(stepId, content, data = null, status = 'done') {
      const step = flowState.get(stepId);
      if (!step) return;

      const time = new Date().toLocaleTimeString();
      step.status = status;
      step.logs.push({ time, content, data });
      renderFlowSteps();
    }

    function renderFlowSteps() {
      const list = document.getElementById('flowList');

      list.innerHTML = FLOW_STEPS.map(stepMeta => {
        const state = flowState.get(stepMeta.id);
        const logs = state?.logs || [];
        const statusClass = state?.status || 'pending';
        const substepClass = stepMeta.isSubstep ? 'substep' : '';

        const logsHtml = logs.length
          ? logs.map(log => `
            <div class="step-log">
              <div class="step-time">${log.time}</div>
              <div class="step-content">${log.content}</div>
              ${log.data ? `<div class="step-data">${typeof log.data === 'object' ? JSON.stringify(log.data, null, 2) : log.data}</div>` : ''}
            </div>
          `).join('')
          : `<div class="step-muted">Bekleniyor...</div>`;

        return `
          <div class="flow-step ${statusClass} ${substepClass}">
            <div class="step-header">
              <span class="step-label">${stepMeta.label}</span>
              <span class="step-direction">${stepMeta.direction}</span>
            </div>
            <div class="step-desc">${stepMeta.desc}</div>
            ${logsHtml}
          </div>
        `;
      }).join('');

      list.scrollTop = list.scrollHeight;
    }

    // ===========================================================================
    // EVENT HANDLERS
    // ===========================================================================

    // Enter tuşuna basıldığında mesaj gönder
    function handleKeyPress(e) {
      if (e.key === 'Enter') sendMessage();
    }

    // ===========================================================================
    // SEND MESSAGE
    // Ana mesaj gönderme fonksiyonu
    // FLOW Adımları: ①⑥⑦
    // ===========================================================================
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      // Boş mesaj gönderme
      if (!message) return;

      // Input'u temizle
      input.value = '';

      // Yeni akış başlatılacaksa flow'u sıfırla
      if (!flowInProgress) {
        resetFlow();
      }

      // ① Kullanıcı mesajını göster
      addMessage(message, 'user');

      // Admin panel'e log ekle (flow.md)
      if (!flowInProgress) {
        addFlowLog(1, `Kullanıcı mesajı: "${message}"`, { message, sessionId }, 'done');
      } else {
        addFlowLog(7, `Kullanıcı yanıtı: "${message}"`, { message, sessionId }, 'active');
      }

      try {
        // Agent'a POST isteği at
        // FLOW: UI → Agent /chat
        const response = await fetch(`${AGENT_URL}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, sessionId })
        });

        // Response'u parse et
        const data = await response.json();

        // =========================================================================
        // ADMIN PANEL DEBUG LOGGING
        // Agent'tan gelen tüm debug bilgilerini göster
        // =========================================================================

        // ②③ MCP tools/list
        if (data.mcp_tools_list_request) {
          addFlowLog(2, 'Agent → MCP tools/list', data.mcp_tools_list_request, 'done');
        } else if (data.tools_obtained) {
          addFlowLog(2, 'Agent → MCP tools/list', { jsonrpc: '2.0', method: 'tools/list' }, 'done');
        }

        if (data.mcp_tools_list_response) {
          addFlowLog(3, 'MCP → Agent tools/list', data.mcp_tools_list_response, 'done');
        } else if (data.tools_obtained) {
          addFlowLog(3, 'MCP → Agent tools/list', { tools: data.tools_obtained }, 'done');
        }

        // ④ LLM'e gönderilen prompt
        if (data.llm_input) {
          addFlowLog(4, 'Gemini\'ye gönderilen prompt', data.llm_input, 'done');
        }

        // ⑤ LLM'den dönen ham yanıt
        if (data.llm_raw_response) {
          addFlowLog(5, 'Gemini\'den dönen ham yanıt', data.llm_raw_response, 'done');
        }

        // LLM'in reasoning'i - neden bu tool seçildi
        if (data.llm_reasoning) {
          addFlowLog(
            5,
            `Seçilen Tool: ${data.tool || 'Yok'}`,
            {
              reasoning: data.llm_reasoning,
              selected_tool: data.tool,
              parameters: data.parameters
            },
            'done'
          );
        }

        // MCP tool call logs will be shown inside 'executing' block in correct order

        // =========================================================================
        // RESPONSE TYPE HANDLING
        // =========================================================================

        if (data.type === 'offer') {
          // ⑥ Kullanıcıya offer göster
          const offerMsg = `<strong>${data.offer_text}</strong>`;
          addMessage(offerMsg, 'offer');

          flowInProgress = true;
          addFlowLog(
            6,
            'Kullanıcıya teklif sunuldu',
            { offer: data.offer_text, tool: data.tool, parameters: data.parameters },
            'done'
          );
        }
        else if (data.type === 'executing') {
          // İşlem başladı - SSE bağlantısı aç
          // Mesaj artık SSE üzerinden gelecek (flow.md'ye uygun)
          flowInProgress = true;

          // ⑦ - Kullanıcı onayı algılandıysa ÖNCE log ekle (flow.md sırası)
          if (data.confirmation_detected) {
            flowInProgress = true;
            addFlowLog(7, `Kullanıcı onayladı: ${data.confirmed_action}`, null, 'done');
          }

          // ⑧ - EXECUTE
          if (data.mcp_tool_call_request) {
            addFlowLog(8, `Agent → MCP tools/call (${data.tool})`, data.mcp_tool_call_request, 'done');
          } else {
            addFlowLog(8, `Agent → MCP tools/call (${data.tool})`, { taskId: data.taskId, tool: data.tool }, 'done');
          }

          if (data.mcp_tool_call_response) {
            addFlowLog(8, 'MCP → Agent tools/call response', data.mcp_tool_call_response, 'done');
          }

          // SSE bağlantısı aç ve event'leri dinle
          connectSSE(data.taskId);
        }
        else if (data.type === 'cancelled') {
          // Kullanıcı iptal etti
          addMessage(data.message, 'bot');
          addFlowLog(7, 'Kullanıcı işlemi iptal etti', null, 'error');
          addFlowLog(14, 'Task iptal edildi', { message: data.message }, 'error');
          flowInProgress = false;
        }
        else {
          // Normal mesaj
          addMessage(data.message, 'bot');
        }

      } catch (err) {
        // Hata durumunda
        addMessage('Hata: ' + err.message, 'bot');
        addFlowLog(14, 'Beklenmeyen hata', err.message, 'error');
        flowInProgress = false;
      }
    }

    // ===========================================================================
    // SSE CONNECTION (flow.md'ye uygun)
    // Server-Sent Events ile real-time update'leri dinle
    // FLOW: UI ←──SSE──→ Agent ←──SSE──→ MCP Server
    // ===========================================================================
    function connectSSE(taskId) {
      // EventSource API ile SSE bağlantısı aç
      // flow.md'ye göre: UI → Agent → MCP Server (Agent proxy yapıyor)
      const sseUrl = `${AGENT_URL}/sse/${taskId}`;

      // ⑪a - UI → Agent SSE proxy bağlantısı
      addFlowLog('11a', 'SSE proxy: UI bağlantısı açılıyor', { url: sseUrl, taskId }, 'active');

      const eventSource = new EventSource(sseUrl);

      // Bağlantı koparsa kullanıcıya bilgi ver
      let reconnectNotified = false;
      let onOpenLogged = false;

      eventSource.onopen = () => {
        if (onOpenLogged) return;
        onOpenLogged = true;
        addFlowLog('11a', 'SSE proxy: UI bağlantısı kuruldu', null, 'active');
      };

      // Her SSE event'i için çağrılır
      eventSource.onmessage = (event) => {
        // JSON parse et
        const data = JSON.parse(event.data);
        const bandwidthEl = document.getElementById('bandwidthValue');

        if (data.type === 'connected') {
          // ⑪ SSE bağlantısı MCP → Agent
          addFlowLog(11, 'SSE bağlantısı kuruldu (MCP → Agent)', data, 'active');
          // ⑪a Agent → UI proxy
          addFlowLog('11a', 'SSE proxy: Bağlantı UI\'a iletildi', data, 'active');
        }
        else if (data.type === 'update') {
          // WORKING status - işlem devam ediyor

          // ⑨ CAMARA API CALL (HTTP - SSE değil)
          if (data.apiCall === 'CAMARA_CREATE_SESSION') {
            addFlowLog(9, 'POST /sessions (HTTP)', data.camaraRequest || data, 'done');
            addFlowLog('11a', 'Proxy: CAMARA API CALL logu iletildi', null, 'active');
            return;
          }

          // ⑩ CAMARA 201 CREATED (HTTP - SSE değil)
          if (data.apiResponse === 'CAMARA_201_CREATED') {
            addFlowLog(10, '201 Created (HTTP)', data.camaraResponse || data, 'done');
            addFlowLog('11a', 'Proxy: CAMARA 201 logu iletildi', null, 'active');
            return;
          }

          // ⑫ CAMARA NOTIFY (HTTP callback - SSE değil) - eğer ayrı update gelirse
          if (data.apiCall === 'CAMARA_NOTIFY') {
            addFlowLog(12, 'CAMARA /notify callback (HTTP)', data.notifyBody || data, 'done');
            addFlowLog('11a', 'Proxy: CAMARA NOTIFY logu iletildi', null, 'active');
            return;
          }

          // ⑪ SSE WORKING (MCP → Agent)
          addFlowLog(11, `WORKING: ${data.message}`, data, 'active');

          // ⑪a SSE PROXY (Agent → UI)
          if (data.userMessage) {
            addMessage(data.userMessage, 'working');
            addFlowLog('11a', `Proxy: "${data.userMessage}"`, null, 'active');
          } else {
            addFlowLog('11a', 'Proxy: Internal log iletildi', null, 'active');
          }

          // Bandwidth göstergesini güncelle (işlem devam ediyor - animasyon)
          if (data.currentBandwidth) {
            bandwidthEl.textContent = data.currentBandwidth;
            bandwidthEl.classList.add('updating');
          }
        }
        else if (data.type === 'complete') {
          // SUCCESS - işlem tamamlandı
          // User panel: userMessage, Admin: message (teknik)
          addMessage(`<strong>${data.userMessage || data.message}</strong>`, 'success');

          // ⑫ CAMARA NOTIFY (HTTP callback - SSE değil)
          if (data.cloudEvent) {
            addFlowLog(12, 'CAMARA /notify callback (HTTP)', data.cloudEvent, 'done');
          }

          // ⑪ SSE akışı tamamlandı
          addFlowLog(11, 'SSE WORKING tamamlandı', null, 'done');
          addFlowLog('11a', 'SSE proxy tamamlandı', null, 'done');

          // ⑬ SSE SUCCESS (MCP → Agent)
          addFlowLog(13, 'SUCCESS SSE (MCP → Agent)', data, 'done');

          // ⑬a SSE PROXY (Agent → UI)
          addFlowLog('13a', 'Proxy: SUCCESS UI\'a iletildi', {
            finalBandwidth: data.finalBandwidth,
            priceInfo: data.priceInfo
          }, 'done');

          // ⑭ Task Done
          addFlowLog(14, 'Task tamamlandı', {
            finalBandwidth: data.finalBandwidth,
            priceInfo: data.priceInfo
          }, 'done');

          flowInProgress = false;

          // Bandwidth göstergesini final değerle güncelle
          if (data.finalBandwidth) {
            bandwidthEl.textContent = data.finalBandwidth;
            bandwidthEl.classList.remove('updating');
          }

          // Bağlantıyı kapat
          eventSource.close();
        }
        else if (data.type === 'ping') {
          // Heartbeat - kullanıcıya gösterme
          return;
        }
        else if (data.type === 'error') {
          // Hata
          addMessage('Hata: ' + data.message, 'bot');
          addFlowLog(11, 'SSE hata (MCP → Agent)', data, 'error');
          addFlowLog('11a', 'SSE proxy hata', null, 'error');
          addFlowLog(14, 'Task hata ile bitti', data, 'error');
          flowInProgress = false;
          bandwidthEl.classList.remove('updating');
          eventSource.close();
        }
      };

      // Bağlantı hatası
      eventSource.onerror = () => {
        const bandwidthEl = document.getElementById('bandwidthValue');
        bandwidthEl.classList.remove('updating');
        addFlowLog(11, 'SSE bağlantısı kapandı', null, 'error');
        addFlowLog('11a', 'SSE proxy bağlantısı kapandı', null, 'error');
        if (!reconnectNotified) {
          addMessage('Bağlantı koptu, tekrar bağlanılıyor...', 'bot');
          reconnectNotified = true;
        }
        eventSource.close();
      };
    }
  </script>
</body>

</html>
