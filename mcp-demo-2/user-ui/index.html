<!--
============================================================================
USER UI - Chat Interface + Admin Debug Panel
============================================================================

Bu dosya kullanÄ±cÄ± arayÃ¼zÃ¼nÃ¼ iÃ§erir. Ä°ki panel var:
1. User Panel: Chat arayÃ¼zÃ¼ (WhatsApp benzeri)
2. Admin Panel: Flow debug (SSE events, LLM reasoning vb.)

FLOW'daki RolÃ¼:
- â‘  KullanÄ±cÄ± mesajÄ±nÄ± Agent'a gÃ¶nderir
- â‘¥ Agent'tan offer alÄ±r, gÃ¶sterir
- â‘¦ KullanÄ±cÄ± onayÄ±nÄ± Agent'a gÃ¶nderir
- â‘ªâ‘¬ MCP Server'dan SSE event'lerini dinler, gÃ¶sterir
- â‘­ Task done gÃ¶sterir

Teknolojiler:
- Vanilla JavaScript (framework yok)
- CSS Variables (WhatsApp renk paleti)
- EventSource API (SSE iÃ§in)

Port: 3000 (server.js ile serve ediliyor)
============================================================================
-->
<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP + CAMARA POC</title>
  <style>
    /* Reset - TÃ¼m elementlerin default margin/padding'ini sÄ±fÄ±rla */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* =========================================================================
       WHATSAPP COLOR PALETTE
       WhatsApp'Ä±n karanlÄ±k temasÄ±ndan alÄ±nan renkler
       ========================================================================= */
    :root {
      --wa-dark-green: #075e54;
      /* Header arka planÄ± */
      --wa-teal: #128c7e;
      /* Butonlar, vurgular */
      --wa-light-green: #25d366;
      /* BaÅŸarÄ±, onay rengi */
      --wa-chat-bg: #0b141a;
      /* Ana arka plan (en koyu) */
      --wa-panel-bg: #111b21;
      /* Panel arka planÄ± */
      --wa-input-bg: #202c33;
      /* Input alanlarÄ± */
      --wa-outgoing: #005c4b;
      /* Giden mesaj (kullanÄ±cÄ±) */
      --wa-incoming: #202c33;
      /* Gelen mesaj (bot) */
      --wa-text: #e9edef;
      /* Ana metin rengi */
      --wa-text-secondary: #8696a0;
      /* Ä°kincil metin (zaman vb.) */
      --wa-border: #2a3942;
      /* KenarlÄ±klar */
    }

    /* Ana body stili */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--wa-chat-bg);
      color: var(--wa-text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* =========================================================================
       HEADER
       Ãœst bar - baÅŸlÄ±k ve panel geÃ§iÅŸ butonu
       ========================================================================= */
    .header {
      background: var(--wa-panel-bg);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--wa-border);
    }

    .header h1 {
      font-size: 18px;
      color: var(--wa-light-green);
    }

    /* Panel geÃ§iÅŸ butonu */
    .toggle-btn {
      background: var(--wa-teal);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
    }

    .toggle-btn:hover {
      background: var(--wa-light-green);
    }

    /* Bandwidth GÃ¶stergesi */
    .bandwidth-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--wa-input-bg);
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--wa-border);
    }

    .bandwidth-label {
      color: var(--wa-text-secondary);
      font-size: 12px;
    }

    .bandwidth-value {
      color: var(--wa-light-green);
      font-weight: bold;
      font-size: 14px;
      min-width: 80px;
      text-align: center;
    }

    .bandwidth-value.updating {
      animation: pulse 0.5s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    /* =========================================================================
       CONTAINER & PANELS
       Ana iÃ§erik alanÄ± ve panel yapÄ±sÄ±
       ========================================================================= */
    .container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow: hidden;
    }

    .panel.hidden {
      display: none;
    }

    /* Gizli panel */

    /* =========================================================================
       CHAT MESSAGES - USER PANEL
       Mesaj baloncuklarÄ±
       ========================================================================= */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
    }

    .message {
      padding: 8px 12px;
      margin: 6px 0;
      border-radius: 8px;
      max-width: 85%;
      font-size: 14px;
      line-height: 1.4;
    }

    /* KullanÄ±cÄ± mesajÄ± - saÄŸda, yeÅŸil arka plan */
    .message.user {
      background: var(--wa-outgoing);
      margin-left: auto;
      /* SaÄŸa yasla */
      border-bottom-right-radius: 0;
      /* WhatsApp baloncuk stili */
    }

    /* Bot mesajÄ± - solda, koyu arka plan */
    .message.bot {
      background: var(--wa-incoming);
      border-bottom-left-radius: 0;
    }

    /* Offer mesajÄ± - sol kenarÄ± yeÅŸil Ã§izgi */
    .message.offer {
      background: var(--wa-incoming);
      border-left: 3px solid var(--wa-light-green);
    }

    /* BaÅŸarÄ± mesajÄ± */
    .message.success {
      background: var(--wa-incoming);
      border-left: 3px solid var(--wa-light-green);
    }

    /* Ã‡alÄ±ÅŸÄ±yor/bekliyor mesajÄ± */
    .message.working {
      background: var(--wa-incoming);
      border-left: 3px solid var(--wa-teal);
    }

    /* =========================================================================
       INPUT AREA
       Mesaj yazma alanÄ±
       ========================================================================= */
    .input-area {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: var(--wa-panel-bg);
      border-radius: 8px;
    }

    .input-area input {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 20px;
      background: var(--wa-input-bg);
      color: var(--wa-text);
      font-size: 14px;
    }

    .input-area input::placeholder {
      color: var(--wa-text-secondary);
    }

    /* GÃ¶nder butonu - yuvarlak */
    .input-area button {
      padding: 12px 20px;
      background: var(--wa-teal);
      border: none;
      border-radius: 50%;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      width: 48px;
      height: 48px;
    }

    .input-area button:hover {
      background: var(--wa-light-green);
    }

    /* =========================================================================
       ADMIN PANEL - FLOW DEBUG
       Debug bilgilerini gÃ¶steren panel
       ========================================================================= */
    .admin-panel {
      background: var(--wa-panel-bg);
    }

    .admin-panel h2 {
      margin-bottom: 15px;
      color: var(--wa-light-green);
      font-size: 16px;
    }

    .flow-list {
      flex: 1;
      overflow-y: auto;
    }

    /* Her bir flow adÄ±mÄ± */
    .flow-step {
      padding: 12px;
      margin: 8px 0;
      background: var(--wa-input-bg);
      border-radius: 8px;
      border-left: 3px solid var(--wa-border);
      font-size: 13px;
    }

    /* Flow step renkleri - tÃ¼re gÃ¶re */
    .flow-step.highlight {
      border-left-color: var(--wa-light-green);
    }

    /* User input, offer */
    .flow-step.llm {
      border-left-color: #f59e0b;
      background: #1a1a0a;
    }

    /* LLM related - turuncu */
    .flow-step.tool {
      border-left-color: #3b82f6;
      background: #0a1a2a;
    }

    /* Tool related - mavi */
    .flow-step.sse {
      border-left-color: #8b5cf6;
      background: #1a0a2a;
    }

    /* SSE related - mor */

    /* Flow step header */
    .flow-step .step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .flow-step .step-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .flow-step .step-label {
      color: var(--wa-light-green);
      font-weight: bold;
      font-size: 11px;
      text-transform: uppercase;
    }

    .flow-step .step-route {
      color: var(--wa-light-green);
      font-size: 10px;
      letter-spacing: 0.3px;
      opacity: 0.9;
      text-transform: uppercase;
    }

    .flow-step .step-time {
      color: var(--wa-text-secondary);
      font-size: 11px;
    }

    .flow-step .step-content {
      color: var(--wa-text);
      margin-bottom: 8px;
    }

    /* JSON data gÃ¶sterimi */
    .flow-step .step-data {
      padding: 8px;
      background: var(--wa-chat-bg);
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
      color: var(--wa-text-secondary);
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <!-- =========================================================================
       HEADER
       ========================================================================= -->
  <div class="header">
    <h1>Network Assistant</h1>

    <!-- Bandwidth GÃ¶stergesi -->
    <div class="bandwidth-indicator">
      <span class="bandwidth-label">Mevcut Bandwidth:</span>
      <span class="bandwidth-value" id="bandwidthValue">200 Mbps</span>
    </div>

    <!-- Panel geÃ§iÅŸ butonu - tÄ±klandÄ±ÄŸÄ±nda togglePanel() Ã§aÄŸrÄ±lÄ±r -->
    <button class="toggle-btn" onclick="togglePanel()">Admin Panel</button>
  </div>

  <div class="container">
    <!-- =========================================================================
         USER PANEL - Chat ArayÃ¼zÃ¼
         ========================================================================= -->
    <div class="panel" id="userPanel">
      <!-- MesajlarÄ±n gÃ¶sterildiÄŸi alan -->
      <div class="chat-messages" id="chatMessages"></div>

      <!-- Mesaj yazma alanÄ± -->
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Ä°stediÄŸiniz talebi yazÄ±n..."
          onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">âž¤</button>
      </div>
    </div>

    <!-- =========================================================================
         ADMIN PANEL - Flow Debug
         ========================================================================= -->
    <div class="panel hidden admin-panel" id="adminPanel">
      <h2>Flow Debug Panel</h2>
      <!-- Flow adÄ±mlarÄ±nÄ±n gÃ¶sterildiÄŸi alan -->
      <div class="flow-list" id="flowList"></div>
    </div>
  </div>

  <script>
    // ===========================================================================
    // CONFIGURATION
    // ===========================================================================

    // Agent API adresi - tÃ¼m istekler buraya gider (SSE dahil)
    // flow.md'ye gÃ¶re: UI â†” Agent â†” MCP Server
    const AGENT_URL = 'http://localhost:5003';

    // CAMARA API - sadece baÅŸlangÄ±Ã§ bandwidth'i almak iÃ§in
    const CAMARA_URL = 'http://localhost:5002';

    // Her sayfa yÃ¼klemesinde unique session ID oluÅŸtur
    // Bu, pending action'larÄ± takip etmek iÃ§in kullanÄ±lÄ±yor
    let sessionId = 'session_' + Date.now();

    // Aktif panel (user veya admin)
    let currentPanel = 'user';

    // Admin panel iÃ§in flow adÄ±mlarÄ±
    let flowSteps = [];

    // ===========================================================================
    // INITIAL BANDWIDTH FETCH
    // Sayfa yÃ¼klendiÄŸinde CAMARA'dan mevcut bandwidth'i al
    // ===========================================================================
    async function fetchInitialBandwidth() {
      try {
        const response = await fetch(`${CAMARA_URL}/network-context`);
        const data = await response.json();
        const bandwidthEl = document.getElementById('bandwidthValue');
        bandwidthEl.textContent = data.currentBandwidth;
        console.log('[UI] Initial bandwidth fetched:', data.currentBandwidth);
      } catch (err) {
        console.error('[UI] Failed to fetch initial bandwidth:', err);
      }
    }

    // Sayfa yÃ¼klendiÄŸinde bandwidth'i al
    window.addEventListener('DOMContentLoaded', fetchInitialBandwidth);

    // ===========================================================================
    // PANEL TOGGLE
    // User ve Admin panel arasÄ±nda geÃ§iÅŸ
    // ===========================================================================
    function togglePanel() {
      const userPanel = document.getElementById('userPanel');
      const adminPanel = document.getElementById('adminPanel');
      const btn = document.querySelector('.toggle-btn');

      if (currentPanel === 'user') {
        // User -> Admin geÃ§iÅŸi
        userPanel.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        btn.textContent = 'User Panel';
        currentPanel = 'admin';
      } else {
        // Admin -> User geÃ§iÅŸi
        adminPanel.classList.add('hidden');
        userPanel.classList.remove('hidden');
        btn.textContent = 'Admin Panel';
        currentPanel = 'user';
      }
    }

    // ===========================================================================
    // CHAT MESSAGES
    // User panel'e mesaj ekleme
    // ===========================================================================
    function addMessage(text, type = 'bot') {
      const messages = document.getElementById('chatMessages');

      // Yeni mesaj elementi oluÅŸtur
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.innerHTML = text; // innerHTML kullanÄ±yoruz Ã§Ã¼nkÃ¼ <strong> vs. olabilir

      // MesajÄ± ekle ve scroll'u aÅŸaÄŸÄ± kaydÄ±r
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    // ===========================================================================
    // FLOW STEPS
    // Admin panel'e flow adÄ±mÄ± ekleme
    // ===========================================================================
    function addFlowStep(label, content, data = null, type = '', route = '') {
      // Zaman damgasÄ±
      const time = new Date().toLocaleTimeString();

      // Flow step'i array'e ekle
      flowSteps.push({ label, content, data, time, type, route });

      // Panel'i yeniden render et
      renderFlowSteps();
    }

    // Flow step'lerini HTML olarak render et
    function renderFlowSteps() {
      const list = document.getElementById('flowList');

      // Her step iÃ§in HTML oluÅŸtur
      list.innerHTML = flowSteps.map((s, i) => `
    <div class="flow-step ${s.type}">
      <div class="step-header">
        <div class="step-left">
          <span class="step-label">${s.label}</span>
          ${s.route ? `<span class="step-route">${s.route}</span>` : ''}
        </div>
        <span class="step-time">${s.time}</span>
      </div>
      <div class="step-content">${s.content}</div>
      ${s.data ? `<div class="step-data">${typeof s.data === 'object' ? JSON.stringify(s.data, null, 2) : s.data}</div>`
          : ''}
    </div>
    `).join('');

      // Scroll'u aÅŸaÄŸÄ± kaydÄ±r
      list.scrollTop = list.scrollHeight;
    }

    // ===========================================================================
    // EVENT HANDLERS
    // ===========================================================================

    // Enter tuÅŸuna basÄ±ldÄ±ÄŸÄ±nda mesaj gÃ¶nder
    function handleKeyPress(e) {
      if (e.key === 'Enter') sendMessage();
    }

    // ===========================================================================
    // SEND MESSAGE
    // Ana mesaj gÃ¶nderme fonksiyonu
    // FLOW AdÄ±mlarÄ±: â‘ â‘¥â‘¦
    // ===========================================================================
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();

      // BoÅŸ mesaj gÃ¶nderme
      if (!message) return;

      // Input'u temizle
      input.value = '';

      // â‘  KullanÄ±cÄ± mesajÄ±nÄ± gÃ¶ster
      addMessage(message, 'user');

      // Admin panel'e log ekle
      addFlowStep('USER INPUT', `KullanÄ±cÄ± mesajÄ±: "${message}"`, null, 'highlight', 'User input');
      addFlowStep('AGENT REQUEST', 'POST /chat', { message, sessionId }, 'tool', 'UI â†’ Agent');

      try {
        // Agent'a POST isteÄŸi at
        // FLOW: UI â†’ Agent /chat
        const response = await fetch(`${AGENT_URL}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, sessionId })
        });

        // Response'u parse et
        const data = await response.json();

        // =========================================================================
        // ADMIN PANEL DEBUG LOGGING
        // Agent'tan gelen tÃ¼m debug bilgilerini gÃ¶ster
        // =========================================================================

        // â‘¡â‘¢ MCP'den alÄ±nan tool listesi
        if (data.mcp_tools_list_request) {
          addFlowStep(
            'MCP TOOLS - REQUEST',
            'Agent â†’ MCP tools/list',
            data.mcp_tools_list_request,
            'tool',
            'Agent â†’ MCP'
          );
        }

        if (data.mcp_tools_list_response) {
          addFlowStep(
            'MCP TOOLS - RESPONSE',
            'MCP â†’ Agent tools/list',
            data.mcp_tools_list_response,
            'tool',
            'MCP â†’ Agent'
          );
        }

        if (data.tools_obtained) {
          addFlowStep(
            'MCP TOOLS',
            `${data.tools_obtained.length} tool MCP Server'dan alÄ±ndÄ±`,
            data.tools_obtained,
            'tool',
            'MCP â†’ Agent'
          );
        }

        // â‘£ LLM'e gÃ¶nderilen prompt
        if (data.llm_input) {
          addFlowStep(
            'LLM INPUT',
            'Gemini\'ye gÃ¶nderilen prompt',
            data.llm_input,
            'llm',
            'Agent â†’ LLM'
          );
        }

        // â‘¤ LLM'den dÃ¶nen ham yanÄ±t
        if (data.llm_raw_response) {
          addFlowStep(
            'LLM RAW RESPONSE',
            'Gemini\'den dÃ¶nen ham yanÄ±t',
            data.llm_raw_response,
            'llm',
            'LLM â†’ Agent'
          );
        }

        // LLM'in reasoning'i - neden bu tool seÃ§ildi
        if (data.llm_reasoning) {
          addFlowStep(
            'LLM REASONING',
            `SeÃ§ilen Tool: ${data.tool || 'Yok'}`,
            {
              reasoning: data.llm_reasoning,
              selected_tool: data.tool,
              parameters: data.parameters
            },
            'llm',
            'Agent internal'
          );
        }

        if (data.mcp_tool_call_request) {
          addFlowStep(
            'MCP CALL - REQUEST',
            `Agent â†’ MCP tools/call (${data.mcp_tool_call_request?.params?.name || 'unknown'})`,
            data.mcp_tool_call_request,
            'tool',
            'Agent â†’ MCP'
          );
        }

        if (data.mcp_tool_call_response) {
          addFlowStep(
            'MCP CALL - RESPONSE',
            'MCP â†’ Agent tools/call',
            data.mcp_tool_call_response,
            'tool',
            'MCP â†’ Agent'
          );
        }

        // =========================================================================
        // RESPONSE TYPE HANDLING
        // =========================================================================

        if (data.type === 'offer') {
          // â‘¥ KullanÄ±cÄ±ya offer gÃ¶ster
          const offerMsg = `<strong>${data.offer_text}</strong>`;
          addMessage(offerMsg, 'offer');

          addFlowStep(
            'OFFER',
            'KullanÄ±cÄ±ya teklif sunuldu',
            { offer: data.offer_text, tool: data.tool, parameters: data.parameters },
            'highlight',
            'Agent â†’ User'
          );
        }
        else if (data.type === 'executing') {
          // Ä°ÅŸlem baÅŸladÄ± - SSE baÄŸlantÄ±sÄ± aÃ§
          // Mesaj artÄ±k SSE Ã¼zerinden gelecek (flow.md'ye uygun)

          // â‘¦a - KullanÄ±cÄ± onayÄ± algÄ±landÄ±ysa log ekle
          if (data.confirmation_detected) {
            addFlowStep(
              'CONFIRMATION',
              `KullanÄ±cÄ± onayladÄ±: ${data.confirmed_action}`,
              null,
              'highlight',
              'User â†’ Agent'
            );
          }

          addFlowStep(
            'EXECUTE',
            `Tool Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor: ${data.tool}`,
            { taskId: data.taskId },
            'tool',
            'Agent â†’ MCP'
          );

          // SSE baÄŸlantÄ±sÄ± aÃ§ ve event'leri dinle
          connectSSE(data.taskId);
        }
        else if (data.type === 'cancelled') {
          // KullanÄ±cÄ± iptal etti
          addMessage(data.message, 'bot');
          addFlowStep('CANCELLED', 'Ä°ÅŸlem kullanÄ±cÄ± tarafÄ±ndan iptal edildi', null, '', 'Agent â†’ User');
        }
        else {
          // Normal mesaj
          addMessage(data.message, 'bot');
        }

      } catch (err) {
        // Hata durumunda
        addMessage('Hata: ' + err.message, 'bot');
        addFlowStep('ERROR', err.message, null, '', 'UI error');
      }
    }

    // ===========================================================================
    // SSE CONNECTION (flow.md'ye uygun)
    // Server-Sent Events ile real-time update'leri dinle
    // FLOW: UI â†â”€â”€SSEâ”€â”€â†’ Agent â†â”€â”€SSEâ”€â”€â†’ MCP Server
    // ===========================================================================
    function connectSSE(taskId) {
      // Admin panel'e SSE baÅŸlangÄ±cÄ±nÄ± log'la
      addFlowStep('SSE', `SSE baÄŸlantÄ±sÄ± aÃ§Ä±lÄ±yor (Agent Ã¼zerinden, taskId: ${taskId})`, null, 'sse', 'UI â†’ Agent (SSE)');

      // EventSource API ile SSE baÄŸlantÄ±sÄ± aÃ§
      // flow.md'ye gÃ¶re: UI â†’ Agent â†’ MCP Server (Agent proxy yapÄ±yor)
      const eventSource = new EventSource(`${AGENT_URL}/sse/${taskId}`);

      // BaÄŸlantÄ± koparsa kullanÄ±cÄ±ya bilgi ver
      let reconnectNotified = false;

      // Her SSE event'i iÃ§in Ã§aÄŸrÄ±lÄ±r
      eventSource.onmessage = (event) => {
        // JSON parse et
        const data = JSON.parse(event.data);
        const bandwidthEl = document.getElementById('bandwidthValue');

        if (data.type === 'connected') {
          // BaÄŸlantÄ± kuruldu
          addFlowStep('SSE', 'BaÄŸlantÄ± kuruldu', { 'Raw SSE Event': data }, 'sse', 'MCP â†’ Agent â†’ UI');
        }
        else if (data.type === 'update') {
          // WORKING status - iÅŸlem devam ediyor

          // User panel: SADECE userMessage varsa gÃ¶ster
          if (data.userMessage) {
            addMessage(data.userMessage, 'working');
            // Bu gerÃ§ek bir SSE Update (flow.md: 11)
            addFlowStep('SSE UPDATE', `AdÄ±m ${data.step}: ${data.message}`, { 'Raw SSE Event': data }, 'sse', 'MCP â†’ Agent â†’ UI');
          } else {
            // userMessage yoksa bu bir INTERNAL logdur (flow.md: 9, 10, 12)
            // Admin panelde farklÄ± gÃ¶rÃ¼nsÃ¼n
            const internalRoute = (data.apiCall === 'CAMARA_NOTIFY' || data.apiResponse || data.camaraResponse || data.camaraStatus)
              ? 'CAMARA â†’ MCP'
              : 'MCP â†’ CAMARA';
            addFlowStep('INTERNAL LOG', `Debug: ${data.message}`, { 'Raw SSE Event': data }, 'tool', internalRoute);
          }

          // Bandwidth gÃ¶stergesini gÃ¼ncelle (iÅŸlem devam ediyor - animasyon)
          if (data.currentBandwidth) {
            bandwidthEl.textContent = data.currentBandwidth;
            bandwidthEl.classList.add('updating');
          }
        }
        else if (data.type === 'complete') {
          // SUCCESS - iÅŸlem tamamlandÄ±
          // User panel: userMessage, Admin: message (teknik)
          addMessage(`<strong>${data.userMessage || data.message}</strong>`, 'success');

          // Admin Panel: FULL RAW DATA Ã¶nce
          addFlowStep('SSE COMPLETE - RAW DATA', 'ðŸ” Tam SSE Event (MCP Server â†’ UI)', { 'Complete Event': data }, 'sse', 'MCP â†’ Agent â†’ UI');

          // CloudEvents bilgisi (CAMARA callback'ten gelen - TÃœM alanlar)
          if (data.cloudEvent) {
            addFlowStep('CAMARA CALLBACK', `CloudEvents: ${data.cloudEvent.type}`, {
              'CloudEvent ID': data.cloudEvent.id,
              'Source': data.cloudEvent.source,
              'Type': data.cloudEvent.type,
              'Spec Version': data.cloudEvent.specversion,
              'Time': data.cloudEvent.time,
              'Content Type': data.cloudEvent.datacontenttype,
              'Data': {
                sessionId: data.cloudEvent.data?.sessionId,
                qosStatus: data.cloudEvent.data?.qosStatus,
                statusInfo: data.cloudEvent.data?.statusInfo
              }
            }, 'tool', 'CAMARA â†’ MCP');
          }

          // Fiyat bilgisi
          if (data.priceInfo) {
            const priceDiff = data.priceInfo.priceDifference;
            const priceText = priceDiff > 0
              ? `+${priceDiff} TL (upgrade)`
              : priceDiff < 0
                ? `${priceDiff} TL (downgrade)`
                : 'DeÄŸiÅŸiklik yok';
            addFlowStep('PRICE INFO', `${data.priceInfo.oldPrice} TL â†’ ${data.priceInfo.newPrice} TL (${priceText})`, data.priceInfo, 'highlight', 'MCP â†’ Agent â†’ UI');
          }

          // Son bandwidth deÄŸeri
          if (data.finalBandwidth) {
            addFlowStep('FINAL BANDWIDTH', `Yeni hÄ±z: ${data.finalBandwidth}`, null, 'highlight', 'MCP â†’ Agent â†’ UI');
          }

          // KullanÄ±cÄ±ya giden mesaj
          if (data.userMessage) {
            addFlowStep('USER MESSAGE', `"${data.userMessage}"`, null, 'highlight', 'MCP â†’ Agent â†’ UI');
          }

          // Bandwidth gÃ¶stergesini final deÄŸerle gÃ¼ncelle
          if (data.finalBandwidth) {
            bandwidthEl.textContent = data.finalBandwidth;
            bandwidthEl.classList.remove('updating');
          }

          // BaÄŸlantÄ±yÄ± kapat
          eventSource.close();
        }
        else if (data.type === 'ping') {
          // Heartbeat - kullanÄ±cÄ±ya gÃ¶sterme
          return;
        }
        else if (data.type === 'error') {
          // Hata
          addMessage('Hata: ' + data.message, 'bot');
          addFlowStep('SSE ERROR', data.message, { 'Raw SSE Event': data }, 'sse', 'MCP â†’ Agent â†’ UI');
          bandwidthEl.classList.remove('updating');
          eventSource.close();
        }
      };

      // BaÄŸlantÄ± hatasÄ±
      eventSource.onerror = () => {
        const bandwidthEl = document.getElementById('bandwidthValue');
        bandwidthEl.classList.remove('updating');
        addFlowStep('SSE', 'BaÄŸlantÄ± kapandÄ±', null, 'sse', 'UI â†’ Agent (SSE)');
        if (!reconnectNotified) {
          addMessage('BaÄŸlantÄ± koptu, tekrar baÄŸlanÄ±lÄ±yor...', 'bot');
          reconnectNotified = true;
        }
        eventSource.close();
      };
    }
  </script>
</body>

</html>
