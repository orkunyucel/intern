version: '3.8'

services:
  # LAYER 5: NETWORK (Mock) - Port 8085
  network-mock-service:
    build:
      context: ./services/network-mock-service
      dockerfile: Dockerfile
    ports:
      - "8085:8085"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/camara/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - mcp-network

  # LAYER 4: CAMARA API - Port 8084
  camara-service:
    build:
      context: ./services/camara-service
      dockerfile: Dockerfile
    ports:
      - "8084:8084"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NETWORK_MOCK_BASE_URL=http://network-mock-service:8085
      - CAMARA_API_BASE_URL=${CAMARA_API_BASE_URL:-}
      - CAMARA_API_TOKEN_URL=${CAMARA_API_TOKEN_URL:-}
      - CAMARA_CLIENT_ID=${CAMARA_CLIENT_ID:-}
      - CAMARA_CLIENT_SECRET=${CAMARA_CLIENT_SECRET:-}
    depends_on:
      network-mock-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/api/camara/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - mcp-network

  # LAYER 3: MCP SERVER - Port 8083
  mcp-server-service:
    build:
      context: ./services/mcp-server-service
      dockerfile: Dockerfile
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - CAMARA_SERVICE_BASE_URL=http://camara-service:8084
    depends_on:
      camara-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/mcp/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - mcp-network

  # LAYER 2: LLM - Port 8082
  llm-service:
    build:
      context: ./services/llm-service
      dockerfile: Dockerfile
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/api/llm/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - mcp-network

  # LAYER 1: CLIENT (Agent) - Port 8081
  ai-agent-service:
    build:
      context: ./services/ai-agent-service
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - LLM_SERVICE_URL=http://llm-service:8082
      - MCP_SERVER_URL=http://mcp-server-service:8083/mcp/jsonrpc
    depends_on:
      mcp-server-service:
        condition: service_healthy
      llm-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/agent/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge
